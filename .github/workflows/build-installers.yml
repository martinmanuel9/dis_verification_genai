name: Build Installers

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
    paths:
      - 'VERSION'  # Only trigger when VERSION file changes
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write  # Required for creating releases and uploading assets

env:
  PRODUCT_NAME: "Verification GenAI"
  PRODUCT_SHORT_NAME: "verification-genai"

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual workflow dispatch
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # Tag push (v1.0.0)
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # Push to main - read from VERSION file
            VERSION=$(cat VERSION)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH (e.g., 1.0.0 or 1.0.0-beta.1)"
            exit 1
          fi
          echo "Version format valid: $VERSION"

      - name: Check if release exists
        id: check_release
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          echo "Checking for release with tag: $TAG"

          # Use GitHub API to check if release exists
          HTTP_CODE=$(curl -s -o /tmp/release.json -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Release $TAG already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
            UPLOAD_URL=$(cat /tmp/release.json | jq -r .upload_url)
            echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG does not exist (HTTP $HTTP_CODE)"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: create_release
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"

          gh release create "$TAG" \
            --title "Release v$VERSION" \
            --notes "# DIS Verification GenAI v$VERSION

          ## Installation

          ### Windows
          Download and run \`dis-verification-genai-$VERSION.msi\`

          ### Linux (Debian/Ubuntu)
          \`\`\`bash
          sudo dpkg -i dis-verification-genai_${VERSION}_amd64.deb
          sudo apt-get install -f  # Install dependencies if needed
          \`\`\`

          ### Linux (RHEL/CentOS/Fedora)
          \`\`\`bash
          sudo rpm -i dis-verification-genai-$VERSION.x86_64.rpm
          \`\`\`

          ### macOS
          Open \`dis-verification-genai-$VERSION.dmg\` and drag to Applications

          ## Prerequisites
          - Docker 24.0.0 or later
          - Docker Compose 2.20.0 or later
          - 8 GB RAM minimum
          - 50 GB disk space
          - 4 CPU cores recommended

          ## What's New
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows Installer
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Update version in WiX
        shell: pwsh
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          (Get-Content installer/windows/Product.wxs) -replace 'VERSION_PLACEHOLDER', $version | Set-Content installer/windows/Product.wxs

      - name: Build WiX installer
        shell: pwsh
        run: |
          cd installer/windows
          candle.exe Product.wxs -ext WixUIExtension -ext WixUtilExtension
          light.exe Product.wixobj -ext WixUIExtension -ext WixUtilExtension -out ../../dis-verification-genai-${{ needs.prepare.outputs.version }}.msi

      - name: Upload Windows Installer
        shell: pwsh
        run: |
          $VERSION = "${{ needs.prepare.outputs.version }}"
          $TAG = "v$VERSION"
          $ASSET_PATH = "dis-verification-genai-$VERSION.msi"

          # Delete existing asset if it exists
          gh release delete-asset $TAG $ASSET_PATH -y -R ${{ github.repository }} 2>$null

          # Upload new asset
          gh release upload $TAG $ASSET_PATH -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-deb:
    name: Build Linux DEB Package
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev build-essential

      - name: Prepare DEB package structure
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          PKG_DIR="dis-verification-genai_${VERSION}_amd64"

          # Create directory structure
          mkdir -p "$PKG_DIR/opt/dis-verification-genai"
          mkdir -p "$PKG_DIR/DEBIAN"

          # Copy application files
          cp -r src "$PKG_DIR/opt/dis-verification-genai/"
          cp -r scripts "$PKG_DIR/opt/dis-verification-genai/"
          cp docker-compose.yml "$PKG_DIR/opt/dis-verification-genai/"
          cp .env.template "$PKG_DIR/opt/dis-verification-genai/.env"
          cp VERSION "$PKG_DIR/opt/dis-verification-genai/"
          cp CHANGELOG.md "$PKG_DIR/opt/dis-verification-genai/"
          cp README.md "$PKG_DIR/opt/dis-verification-genai/"

          # Copy DEBIAN control files
          cp installer/linux/DEBIAN/* "$PKG_DIR/DEBIAN/"

          # Update version in control file
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" "$PKG_DIR/DEBIAN/control"

          # Set permissions
          chmod 755 "$PKG_DIR/DEBIAN/postinst"
          chmod 755 "$PKG_DIR/DEBIAN/prerm"
          chmod 755 "$PKG_DIR/DEBIAN/postrm"

          # Build DEB package
          dpkg-deb --build "$PKG_DIR"

      - name: Upload Linux DEB Package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="v$VERSION"
          ASSET_PATH="dis-verification-genai_${VERSION}_amd64.deb"

          # Upload with clobber to replace if exists
          gh release upload "$TAG" "$ASSET_PATH" -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-rpm:
    name: Build Linux RPM Package
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install RPM tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Create RPM spec file
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cat > dis-verification-genai.spec <<'SPECEOF'
          Name:           dis-verification-genai
          Version:        %{_version}
          Release:        1%{?dist}
          Summary:        AI-powered verification and test plan generation system
          License:        Proprietary
          URL:            https://github.com/${{ github.repository }}
          Source0:        %{name}-%{version}.tar.gz
          Requires:       docker >= 24.0.0
          BuildArch:      x86_64

          %description
          DIS Verification GenAI provides comprehensive test plan generation and
          verification capabilities using advanced AI models.

          %prep
          %setup -q -n %{name}-%{version}

          %install
          mkdir -p %{buildroot}/opt/dis-verification-genai
          cp -r src %{buildroot}/opt/dis-verification-genai/
          cp -r scripts %{buildroot}/opt/dis-verification-genai/
          cp docker-compose.yml %{buildroot}/opt/dis-verification-genai/
          cp .env.template %{buildroot}/opt/dis-verification-genai/.env
          cp VERSION %{buildroot}/opt/dis-verification-genai/
          cp CHANGELOG.md %{buildroot}/opt/dis-verification-genai/
          cp README.md %{buildroot}/opt/dis-verification-genai/

          %files
          /opt/dis-verification-genai

          %post
          echo "DIS Verification GenAI installed successfully"

          %preun
          # Pre-uninstall script

          %changelog
          * $(date +'%a %b %d %Y') GitHub Actions <actions@github.com> - %{version}-1
          - Release %{version}
          SPECEOF

          # Replace version placeholder
          sed -i "s/%{_version}/$VERSION/g" dis-verification-genai.spec

      - name: Build RPM package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp dis-verification-genai.spec ~/rpmbuild/SPECS/

          # Create source tarball with proper directory structure
          mkdir -p dis-verification-genai-$VERSION
          cp -r src scripts docker-compose.yml .env.template VERSION CHANGELOG.md README.md dis-verification-genai-$VERSION/
          tar czf ~/rpmbuild/SOURCES/dis-verification-genai-$VERSION.tar.gz dis-verification-genai-$VERSION
          rm -rf dis-verification-genai-$VERSION

          # Build RPM
          rpmbuild -ba ~/rpmbuild/SPECS/dis-verification-genai.spec

          # Copy built RPM
          find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} ./ \;

      - name: Find and upload RPM
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          RPM_FILE=$(ls dis-verification-genai-$VERSION-*.x86_64.rpm | head -1)
          echo "RPM_FILE=$RPM_FILE" >> $GITHUB_ENV

      - name: Upload Linux RPM Package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="v$VERSION"
          RPM_FILE="${{ env.RPM_FILE }}"

          # Upload with clobber to replace if exists, rename to standard name
          gh release upload "$TAG" "$RPM_FILE#dis-verification-genai-$VERSION.x86_64.rpm" -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS DMG
    needs: prepare
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create DMG
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          APP_NAME="DIS Verification GenAI"
          DMG_NAME="dis-verification-genai-$VERSION.dmg"

          # Create app bundle structure
          mkdir -p "build/$APP_NAME.app/Contents/MacOS"
          mkdir -p "build/$APP_NAME.app/Contents/Resources"

          # Copy application files
          cp -r src "build/$APP_NAME.app/Contents/Resources/"
          cp -r scripts "build/$APP_NAME.app/Contents/Resources/"
          cp docker-compose.yml "build/$APP_NAME.app/Contents/Resources/"
          cp .env.template "build/$APP_NAME.app/Contents/Resources/.env"
          cp VERSION "build/$APP_NAME.app/Contents/Resources/"
          cp CHANGELOG.md "build/$APP_NAME.app/Contents/Resources/"
          cp README.md "build/$APP_NAME.app/Contents/Resources/"

          # Create Info.plist
          cat > "build/$APP_NAME.app/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>DIS Verification GenAI</string>
              <key>CFBundleVersion</key>
              <string>$VERSION</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>CFBundleExecutable</key>
              <string>launcher</string>
          </dict>
          </plist>
          EOF

          # Create launcher script
          cat > "build/$APP_NAME.app/Contents/MacOS/launcher" <<'EOF'
          #!/bin/bash
          cd "$(dirname "$0")/../Resources"
          docker compose up -d
          open http://localhost:8501
          EOF
          chmod +x "build/$APP_NAME.app/Contents/MacOS/launcher"

          # Create DMG
          hdiutil create -volname "$APP_NAME" -srcfolder build -ov -format UDZO "$DMG_NAME"

      - name: Upload macOS DMG
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="v$VERSION"
          ASSET_PATH="dis-verification-genai-$VERSION.dmg"

          # Upload with clobber to replace if exists
          gh release upload "$TAG" "$ASSET_PATH" -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  checksums:
    name: Generate Checksums
    needs: [prepare, build-windows, build-linux-deb, build-linux-rpm, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release assets
        run: |
          TAG="v${{ needs.prepare.outputs.version }}"
          VERSION="${{ needs.prepare.outputs.version }}"

          # Download all release assets
          gh release download "$TAG" --pattern "*.msi" -R ${{ github.repository }} || true
          gh release download "$TAG" --pattern "*.deb" -R ${{ github.repository }} || true
          gh release download "$TAG" --pattern "*.rpm" -R ${{ github.repository }} || true
          gh release download "$TAG" --pattern "*.dmg" -R ${{ github.repository }} || true

          ls -la
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate checksums
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          # Wait a bit for uploads to complete
          echo "Waiting for assets to be uploaded..."
          sleep 10

          # Download again to make sure we have the latest
          TAG="v$VERSION"
          gh release download "$TAG" --pattern "*.msi" -R ${{ github.repository }} --clobber || true
          gh release download "$TAG" --pattern "*.deb" -R ${{ github.repository }} --clobber || true
          gh release download "$TAG" --pattern "*.rpm" -R ${{ github.repository }} --clobber || true
          gh release download "$TAG" --pattern "*.dmg" -R ${{ github.repository }} --clobber || true

          ls -la

          # Generate checksums only for files that exist
          rm -f checksums-sha256.txt
          [ -f "dis-verification-genai-$VERSION.msi" ] && sha256sum dis-verification-genai-$VERSION.msi >> checksums-sha256.txt
          [ -f "dis-verification-genai_${VERSION}_amd64.deb" ] && sha256sum dis-verification-genai_${VERSION}_amd64.deb >> checksums-sha256.txt
          [ -f "dis-verification-genai-$VERSION.x86_64.rpm" ] && sha256sum dis-verification-genai-$VERSION.x86_64.rpm >> checksums-sha256.txt
          [ -f "dis-verification-genai-$VERSION.dmg" ] && sha256sum dis-verification-genai-$VERSION.dmg >> checksums-sha256.txt

          if [ -f checksums-sha256.txt ]; then
            cat checksums-sha256.txt
          else
            echo "No files found to checksum"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload checksums
        if: hashFiles('checksums-sha256.txt') != ''
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="v$VERSION"

          # Upload with clobber to replace if exists
          gh release upload "$TAG" checksums-sha256.txt -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
